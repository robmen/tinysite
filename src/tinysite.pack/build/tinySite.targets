<?xml version="1.0" encoding="utf-8"?>
<Project DefaultTargets="Build" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <Import Project="$(MSBuildToolsPath)\Microsoft.Common.targets" />

  <PropertyGroup>
    <MSBuildAllProjects>$(MSBuildAllProjects);$(MSBuildThisFileFullPath)</MSBuildAllProjects>
  </PropertyGroup>

  <PropertyGroup>
    <TinySiteExe Condition=" '$(TinySiteExe)' == '' ">$([System.IO.Path]::GetFullPath('$(MSBuildThisFileDirectory)..\tools\tinysite.exe'))</TinySiteExe>
    <StaticIntermediateFolder>$(BaseIntermediateFolder)</StaticIntermediateFolder>
    <PublishFolder Condition=" '$(PublishFolder)' == '' ">$(OutputPath)</PublishFolder>
    <PublishFolder Condition=" '$(PublishFolder)' != '' and !HasTrailingSlash('$(PublishFolder)') ">$(PublishFolder)\</PublishFolder>

    <SitemapXmlFile>$(PublishFolder)sitemap.xml</SitemapXmlFile>
    <SitemapFrequency Condition=" '$(SitemapFrequency)' == '' ">weekly</SitemapFrequency>
  </PropertyGroup>

  <Target Name="Build" DependsOnTargets="BuildStaticFiles;BuildSitemap" />

  <!--
  ================================================================================================
  BuildStaticFiles

    Runs tinySite to publish.
  ================================================================================================
  -->
  <Target Name="BuildStaticFiles"
          DependsOnTargets="_CalculateStaticInputsOutputs"
          Inputs="@(StaticInput)"
          Outputs="@(StaticOutput)">

    <Exec Command="&quot;$(TinySiteExe)&quot; render -o &quot;$(PublishFolder) &quot;"
          WorkingDirectory="$(MSBuildProjectDirectory)" />

    <Message Importance='high' Text="$(MSBuildProjectFile) -&gt; $(PublishFolder)" />
  </Target>

  <Target Name="_CalculateStaticInputsOutputs">
    <ItemGroup>
      <StaticInput Include="$(MSBuildProjectDirectory)\site.json" />
      <StaticInput Include="$(MSBuildProjectDirectory)\documents\**" />
      <StaticInput Include="$(MSBuildProjectDirectory)\files\**" />
      <StaticInput Include="$(MSBuildProjectDirectory)\layout\**" />
      <StaticOutput Include="$(StaticIntermediateFolder)**" />
      <StaticOutput Include="$(StaticIntermediateFolder)" Condition=" '@(StaticOutput)'=='' " />
    </ItemGroup>
  </Target>

  <!--
  ================================================================================================
  BuildSitemap

    Writes the sitemap.xml.
  ================================================================================================
  -->
  <PropertyGroup>
    <BuildSitemapDependsOn>
      $(BuildSitemapDependsOn);
      _CalculateHtmlFiles
    </BuildSitemapDependsOn>
  </PropertyGroup>
  <Target Name="BuildSitemap"
          Condition=" '$(SitemapRootUrl)'!='' "
          DependsOnTargets="$(BuildSitemapDependsOn)"
          Inputs="$(MSBuildAllProjects);@(_CalculatedHtmlFiles)"
          Outputs="$(SitemapXmlFile)">

    <ItemGroup>
      <Url Include="$([System.String]::Copy('%(HtmlFile.Identity)').Replace('\', '/'))" />
    </ItemGroup>

    <ItemGroup>
      <Line Include='&lt;?xml version="1.0" encoding="UTF-8"?&gt;' />
      <Line Include='&lt;urlset xmlns="http://www.sitemaps.org/schemas/sitemap/0.9"&gt;' />
      <Line Include="&lt;url&gt;&lt;loc&gt;$(SitemapRootUrl)&lt;/loc&gt;&lt;changefreq&gt;$(SitemapFrequency)&lt;/changefreq&gt;&lt;/url&gt;" />
      <Line Include="&lt;url&gt;&lt;loc&gt;$(SitemapRootUrl)%(Url.Identity)&lt;/loc&gt;&lt;changefreq&gt;$(SitemapFrequency)&lt;/changefreq&gt;&lt;/url&gt;" />
      <Line Include='&lt;/urlset&gt;' />
    </ItemGroup>

    <WriteLinesToFile File="$(SitemapXmlFile)"
                      Lines="@(Line)"
                      Overwrite="true"
                      Encoding="utf-8" />

    <ItemGroup>
      <Content Include="$(SitemapXmlFile)">
        <Link>sitemap.xml</Link>
      </Content>
    </ItemGroup>
  </Target>

  <Target Name="_CalculateHtmlFiles">
    <ItemGroup>
      <_CalculatedHtmlFiles Include="$(PublishFolder)**\*.html" Exclude="@(SitemapExcludeFiles);$(SitemapExcludeFiles)" />
      <HtmlFile Include="@(_CalculatedHtmlFiles->'%(RecursiveDir)')" Condition=" '%(Filename)'=='index' " />
      <HtmlFile Include="@(_CalculatedHtmlFiles->'%(RecursiveDir)%(Filename)%(Extension)')" Condition=" '%(Filename)'!='index' " />
    </ItemGroup>
  </Target>
</Project>
